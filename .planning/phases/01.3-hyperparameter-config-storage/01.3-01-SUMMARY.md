# Phase 1.3 Plan 01: Hyperparameter Config Storage Summary

**One-liner:** Nullable JSON generation_config on commits threaded through full commit/compile/query pipeline with copy-on-output cache safety, edit-inherits-original fallback, and SQL-side json_extract querying.

## Tasks Completed

| Task | Name | Commit | Tests |
|------|------|--------|-------|
| 1 | Add generation_config to data model, storage, engine, and compiler | 8f8f950 | 0 (structural) |
| 2 | Wire generation_config through Tract facade | 27cbe8e | 0 (structural) |
| 3 | Write integration and unit tests | af4d189 | 30 |

## What Was Built

### CommitInfo.generation_config Field (models/commit.py)
- `generation_config: Optional[dict] = None` on CommitInfo Pydantic model
- Accepts any provider's hyperparameters (temperature, top_p, model, etc.)
- Immutable once committed (set at commit time only)

### CommitRow.generation_config_json Column (storage/schema.py)
- Nullable JSON column following the same pattern as metadata_json
- No index (known limitation; SQLite generated column indexes can be added later)

### get_by_config Repository Method (storage/repositories.py, storage/sqlite.py)
- Abstract method on CommitRepository ABC with 6 comparison operators
- SQLite implementation using `func.json_extract()` for SQL-side filtering
- Scoped by tract_id, ordered by created_at ascending

### CommitEngine Threading (engine/commit.py)
- `generation_config` parameter added to `create_commit()` signature
- Stored as `generation_config_json` on CommitRow
- Returned as `generation_config` on CommitInfo via `_row_to_info()`
- NOT included in commit hash computation (same content = same content_hash)

### Compiler Config Collection (engine/compiler.py)
- Step 4b: Collects generation_configs parallel to effective commits
- Edit-inherits-original fallback: when EDIT has no config, original's config is preserved
- SKIP priority commits excluded from generation_configs list

### CompiledContext.generation_configs and CompileSnapshot.generation_configs (protocols.py)
- `CompiledContext.generation_configs: list[dict]` -- parallel to effective commits
- `CompileSnapshot.generation_configs: tuple[dict, ...]` -- cached version

### Tract Facade Methods (tract.py)
- `commit(..., generation_config={...})` -- pass config through to engine
- `compile()` -- returns generation_configs via both full compile and incremental cache
- `query_by_config(field, operator, value)` -- SQL-side JSON querying
- Copy-on-output in `_snapshot_to_compiled()` prevents cache corruption
- Copy-on-input in `_build_snapshot_from_compiled()` prevents mutation through returned result

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Copy-on-input needed in _build_snapshot_from_compiled**

- **Found during:** Task 3 (cache safety test failure)
- **Issue:** `_build_snapshot_from_compiled()` stored direct references to the dict objects from the compile result. When user mutated the returned CompiledContext's generation_configs, the cached snapshot was corrupted.
- **Fix:** Added `dict(c) for c` comprehension in `_build_snapshot_from_compiled()` to shallow-copy dicts when building the snapshot from a compile result, complementing the copy-on-output in `_snapshot_to_compiled()`.
- **Files modified:** `src/tract/tract.py`
- **Commit:** af4d189

## Decisions Made

- generation_config is set at commit time ONLY (immutable once written)
- record_usage() is NOT extended with generation_config (config is always known before API call)
- Copy-on-output AND copy-on-input patterns together prevent cache corruption from mutable dicts
- Edit-inherits-original: when EDIT has no generation_config, the original commit's config is preserved in compiled output
- No index on generation_config_json column (acceptable at Phase 1 scale)
- generation_config is NOT part of commit hash computation (content_hash identical for same content regardless of config)

## Test Summary

| Category | Count |
|----------|-------|
| Integration tests (TestGenerationConfig) | 16 |
| Repository unit tests (TestSqliteCommitRepositoryGetByConfig) | 5 |
| Engine unit tests (TestGenerationConfig) | 4 |
| Compiler unit tests (TestGenerationConfigCollection) | 5 |
| **Total new tests** | **30** |
| **Total suite** | **250** |
| Regressions | 0 |

## Key Files

### Created
None (all modifications to existing files)

### Modified
- `src/tract/models/commit.py` -- generation_config field on CommitInfo
- `src/tract/storage/schema.py` -- generation_config_json column on CommitRow
- `src/tract/storage/repositories.py` -- get_by_config abstract method
- `src/tract/storage/sqlite.py` -- get_by_config implementation with json_extract
- `src/tract/engine/commit.py` -- generation_config threading through create_commit/_row_to_info
- `src/tract/engine/compiler.py` -- generation_config collection during compile
- `src/tract/protocols.py` -- generation_configs on CompiledContext and CompileSnapshot
- `src/tract/tract.py` -- commit(), compile(), query_by_config(), cache safety
- `tests/test_tract.py` -- TestGenerationConfig (16 tests)
- `tests/test_storage/test_repositories.py` -- TestSqliteCommitRepositoryGetByConfig (5 tests)
- `tests/test_engine/test_commit.py` -- TestGenerationConfig (4 tests)
- `tests/test_engine/test_compiler.py` -- TestGenerationConfigCollection (5 tests)

## Phase 1.3 Completion Status

Phase 1.3 has 1 plan, now complete:

| Plan | Name | Tests | Duration |
|------|------|-------|----------|
| 01.3-01 | Hyperparameter Config Storage | 30 | ~3m |

Total test suite: 250 tests passing (220 + 30 new).

## Next Phase Readiness

Phase 1.3 is complete. Generation config storage provides:
- Full LLM call provenance (temperature, model, top_p stored with each commit)
- SQL-side querying for config-based analysis (e.g., find all high-temperature commits)
- Cache-safe compilation with generation_configs parallel to effective commits
- Edit-inherits-original semantics for clean provenance chains

Ready to proceed to Phase 2 (Linear History).
