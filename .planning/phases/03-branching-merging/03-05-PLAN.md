---
phase: 03-branching-merging
plan: 05
type: execute
wave: 4
depends_on: ["03-01", "03-03"]
files_modified:
  - src/tract/cli/__init__.py
  - src/tract/cli/commands/branch.py
  - src/tract/cli/commands/switch.py
  - src/tract/cli/commands/merge.py
  - src/tract/cli/formatting.py
  - tests/test_cli.py
autonomous: true

must_haves:
  truths:
    - "User can run tract branch to list all branches with current branch highlighted"
    - "User can run tract branch create NAME to create and switch to a new branch"
    - "User can run tract branch delete NAME to delete a non-current branch"
    - "User can run tract switch NAME to switch to a branch"
    - "User can run tract merge SOURCE to merge a branch into the current branch"
    - "tract merge shows MergeResult summary (fast-forward, clean, or conflicts)"
    - "CLI degrades gracefully when piped (no ANSI codes)"
  artifacts:
    - path: "src/tract/cli/commands/branch.py"
      provides: "tract branch command group"
      contains: "def branch"
    - path: "src/tract/cli/commands/switch.py"
      provides: "tract switch command"
      contains: "def switch"
    - path: "src/tract/cli/commands/merge.py"
      provides: "tract merge command"
      contains: "def merge"
    - path: "src/tract/cli/formatting.py"
      provides: "Formatting helpers for branch list and merge result"
      contains: "format_branches"
    - path: "tests/test_cli.py"
      provides: "CLI tests for branch, switch, merge"
      min_lines: 50
  key_links:
    - from: "src/tract/cli/commands/branch.py"
      to: "src/tract/tract.py"
      via: "CLI branch calls Tract.branch(), Tract.list_branches(), Tract.delete_branch()"
      pattern: "tract_obj.branch|tract_obj.list_branches|tract_obj.delete_branch"
    - from: "src/tract/cli/commands/switch.py"
      to: "src/tract/tract.py"
      via: "CLI switch calls Tract.switch()"
      pattern: "tract_obj.switch"
    - from: "src/tract/cli/commands/merge.py"
      to: "src/tract/tract.py"
      via: "CLI merge calls Tract.merge()"
      pattern: "tract_obj.merge"
---

<objective>
Add CLI commands for branch management, switching, and merging -- the terminal-facing counterpart to the SDK branch/merge operations built in Plans 03-01 and 03-03.

Purpose: CONTEXT.md ยง7 specifies `tract branch`, `tract switch`, `tract merge` as Phase 3 CLI deliverables. These are thin presentation wrappers over SDK operations, following the Phase 2 CLI pattern (Click + Rich).
Output: Three new CLI commands registered on the existing Click group, with Rich formatting and CliRunner tests.
</objective>

<execution_context>
@C:\Users\jinwi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jinwi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-branching-merging/03-CONTEXT.md
@.planning/phases/03-branching-merging/03-01-SUMMARY.md
@.planning/phases/03-branching-merging/03-03-SUMMARY.md

@src/tract/cli/__init__.py
@src/tract/cli/formatting.py
@src/tract/cli/commands/checkout.py
@src/tract/tract.py
@src/tract/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Branch, switch, and merge CLI commands with formatting and tests</name>
  <files>
    src/tract/cli/__init__.py
    src/tract/cli/commands/branch.py
    src/tract/cli/commands/switch.py
    src/tract/cli/commands/merge.py
    src/tract/cli/formatting.py
    tests/test_cli.py
  </files>
  <action>
1. **cli/commands/branch.py** -- `tract branch` command group:
   - `@click.group(invoke_without_command=True)` so `tract branch` with no subcommand lists branches.
   - **`tract branch` (no subcommand):** Call `tract_obj.list_branches()`, format with `format_branches()`. Show `*` marker on current branch (matching `git branch` output).
   - **`tract branch create NAME [--no-switch] [--source COMMIT]`:** Call `tract_obj.branch(name, source=source, switch=not no_switch)`. Print confirmation: "Created branch '{name}' at {hash[:8]}" and "Switched to branch '{name}'" if switched.
   - **`tract branch delete NAME [--force]`:** Call `tract_obj.delete_branch(name, force=force)`. Print "Deleted branch '{name}'". Handle errors: current branch, unmerged commits.

2. **cli/commands/switch.py** -- `tract switch NAME`:
   - `@click.command()`
   - Call `tract_obj.switch(target)`.
   - Print "Switched to branch '{target}' at {hash[:8]}".
   - Handle `BranchNotFoundError` with a helpful message listing available branches.

3. **cli/commands/merge.py** -- `tract merge SOURCE [--no-ff] [--strategy auto|semantic]`:
   - `@click.command()`
   - Call `tract_obj.merge(source_branch, no_ff=no_ff, strategy=strategy)`.
   - Format result with `format_merge_result()`:
     - Fast-forward: "Fast-forward: {branch} -> {hash[:8]}"
     - Clean merge: "Merged {source} into {target} (merge commit: {hash[:8]})"
     - Conflicts: "CONFLICT: {n} conflicts detected. Use the SDK to resolve and commit."
     - List each conflict type and target.
   - Handle `NothingToMergeError`: "Already up to date."
   - Handle `MergeError`: print error message.

4. **cli/formatting.py** -- Add formatting helpers:
   - `format_branches(branches: list[BranchInfo], console: Console) -> None`:
     - For each branch: print `* name` (green, bold) if current, `  name` otherwise.
     - Include commit hash suffix: `name  {hash[:8]}`.
   - `format_merge_result(result: MergeResult, console: Console) -> None`:
     - Format based on merge_type (fast_forward, clean, conflict, semantic).
     - For conflicts, list each ConflictInfo with type and target hash.

5. **cli/__init__.py** -- Register new commands:
   - Add imports and `cli.add_command()` calls for branch, switch, merge after existing commands.

6. **tests/test_cli.py** -- Append new tests (~50+ lines) to the existing test file:

   **Branch tests:**
   - `test_branch_list`: Create branches, invoke `tract branch --db test.db`, verify output shows branch names with `*` marker.
   - `test_branch_create`: `tract branch create feature --db test.db`, verify "Created branch" in output.
   - `test_branch_create_no_switch`: `tract branch create feature --no-switch --db test.db`, verify branch created but not switched.
   - `test_branch_delete`: Create and delete a branch, verify "Deleted branch" in output.
   - `test_branch_delete_current_errors`: Try deleting current branch, verify error message.

   **Switch tests:**
   - `test_switch_to_branch`: `tract switch feature --db test.db`, verify "Switched to branch" in output.
   - `test_switch_nonexistent`: `tract switch nope --db test.db`, verify error message.

   **Merge tests:**
   - `test_merge_fast_forward`: Create branch, commit on it, switch back, `tract merge feature --db test.db`, verify "Fast-forward" in output.
   - `test_merge_clean`: Diverge branches, merge, verify "Merged" in output.
   - `test_merge_already_up_to_date`: Merge a branch that is ancestor, verify "Already up to date" in output.

   All tests use `runner.isolated_filesystem()` with file-backed databases. Setup pattern matches existing Phase 2 CLI tests.
  </action>
  <verify>
    `python -m pytest tests/test_cli.py -x -q` -- all CLI tests pass (existing + new).
    `python -m pytest tests/ -x -q` -- full suite passes.
  </verify>
  <done>
    - `tract branch` lists branches with `*` on current
    - `tract branch create feature` creates and switches
    - `tract branch delete feature` removes branch
    - `tract switch main` switches branches
    - `tract merge feature` shows merge result summary
    - All existing + new tests pass
  </done>
</task>

</tasks>

<verification>
1. `tract branch` lists branches with current branch highlighted
2. `tract branch create feature` creates branch and switches to it
3. `tract branch create feature --no-switch` creates without switching
4. `tract branch delete feature` deletes non-current branch
5. `tract switch main` switches to branch
6. `tract merge feature` shows fast-forward/clean/conflict result
7. All CLI tests pass via CliRunner
8. Full test suite passes
</verification>

<success_criteria>
- Three new CLI commands (branch, switch, merge) registered on existing Click group
- Rich formatting for branch list and merge results
- Error handling for common failures (branch not found, current branch delete, merge conflicts)
- CLI degrades gracefully when piped
- All existing + new tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-branching-merging/03-05-SUMMARY.md`
</output>
</output>
