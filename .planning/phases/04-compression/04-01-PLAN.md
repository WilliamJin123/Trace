---
phase: 04-compression
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/tract/storage/schema.py
  - src/tract/storage/repositories.py
  - src/tract/storage/sqlite.py
  - src/tract/storage/engine.py
  - src/tract/models/compression.py
  - src/tract/prompts/__init__.py
  - src/tract/prompts/summarize.py
  - src/tract/exceptions.py
  - tests/test_compression_storage.py
autonomous: true

must_haves:
  truths:
    - "CompressionRow, CompressionSourceRow, CompressionResultRow tables exist in schema and are created by init_db()"
    - "Schema migration from v2 to v3 runs automatically for existing databases"
    - "CompressionRepository ABC defines save_record, get_record, get_sources, get_results, is_source_of methods"
    - "SqliteCompressionRepository implements all ABC methods with working SQLite queries"
    - "CompressResult, PendingCompression, GCResult, ReorderWarning models are importable from tract.models.compression"
    - "CompressionError exception exists in tract.exceptions"
    - "Default summarization prompt is importable from tract.prompts.summarize"
  artifacts:
    - path: "src/tract/storage/schema.py"
      provides: "3 new ORM tables for compression provenance"
      contains: "CompressionRow"
    - path: "src/tract/storage/repositories.py"
      provides: "CompressionRepository ABC"
      contains: "class CompressionRepository"
    - path: "src/tract/storage/sqlite.py"
      provides: "SqliteCompressionRepository implementation"
      contains: "class SqliteCompressionRepository"
    - path: "src/tract/storage/engine.py"
      provides: "v2->v3 migration"
      contains: "elif existing.value == \"2\""
    - path: "src/tract/models/compression.py"
      provides: "CompressResult, PendingCompression, GCResult, ReorderWarning"
      contains: "class CompressResult"
    - path: "src/tract/prompts/summarize.py"
      provides: "DEFAULT_SUMMARIZE_SYSTEM, build_summarize_prompt"
      contains: "DEFAULT_SUMMARIZE_SYSTEM"
    - path: "src/tract/exceptions.py"
      provides: "CompressionError"
      contains: "class CompressionError"
  key_links:
    - from: "src/tract/storage/schema.py"
      to: "src/tract/storage/engine.py"
      via: "init_db() creates compression tables via migration"
      pattern: "compressions.*create"
    - from: "src/tract/storage/repositories.py"
      to: "src/tract/storage/sqlite.py"
      via: "SqliteCompressionRepository implements CompressionRepository ABC"
      pattern: "CompressionRepository"
    - from: "src/tract/storage/schema.py"
      to: "src/tract/storage/sqlite.py"
      via: "SqliteCompressionRepository queries CompressionRow/SourceRow/ResultRow"
      pattern: "CompressionRow"
---

<objective>
Establish the storage foundation for compression: schema tables, repository pattern, domain models, and default summarization prompt.

Purpose: Compression needs relational provenance tracking (not JSON metadata) so users can query "what sources produced this summary?" and "was this commit ever compressed?" These tables and models are prerequisites for the compression engine (04-02) and GC (04-03).

Output: 3 new ORM tables with migration, repository ABC + SQLite impl, 4 domain models, compression exception, and summarization prompt module. All existing 489 tests continue to pass.
</objective>

<execution_context>
@C:\Users\jinwi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jinwi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-compression/04-CONTEXT.md
@.planning/phases/04-compression/04-RESEARCH.md
@src/tract/storage/schema.py
@src/tract/storage/repositories.py
@src/tract/storage/sqlite.py
@src/tract/storage/engine.py
@src/tract/models/merge.py
@src/tract/exceptions.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: CompressionRecord schema tables + migration + repository</name>
  <files>
    src/tract/storage/schema.py
    src/tract/storage/repositories.py
    src/tract/storage/sqlite.py
    src/tract/storage/engine.py
  </files>
  <action>
    **schema.py** -- Add 3 new ORM classes after CommitParentRow:

    1. `CompressionRow(Base)` -- tablename "compressions":
       - `compression_id: Mapped[str]` -- String(64), primary_key=True
       - `tract_id: Mapped[str]` -- String(64), nullable=False, index=True
       - `branch_name: Mapped[Optional[str]]` -- String(255), nullable=True (branch at time of compression)
       - `created_at: Mapped[datetime]` -- DateTime, nullable=False
       - `original_tokens: Mapped[int]` -- Integer, nullable=False
       - `compressed_tokens: Mapped[int]` -- Integer, nullable=False
       - `target_tokens: Mapped[Optional[int]]` -- Integer, nullable=True
       - `instructions: Mapped[Optional[str]]` -- Text, nullable=True (user instructions appended to prompt)

    2. `CompressionSourceRow(Base)` -- tablename "compression_sources":
       - `compression_id: Mapped[str]` -- String(64), ForeignKey("compressions.compression_id"), primary_key=True
       - `commit_hash: Mapped[str]` -- String(64), ForeignKey("commits.commit_hash"), primary_key=True
       - `position: Mapped[int]` -- Integer, nullable=False (order of source commit)

    3. `CompressionResultRow(Base)` -- tablename "compression_results":
       - `compression_id: Mapped[str]` -- String(64), ForeignKey("compressions.compression_id"), primary_key=True
       - `commit_hash: Mapped[str]` -- String(64), ForeignKey("commits.commit_hash"), primary_key=True
       - `position: Mapped[int]` -- Integer, nullable=False (order of summary commit)

    **repositories.py** -- Add `CompressionRepository(ABC)` after AnnotationRepository:
    - `save_record(compression_id, tract_id, branch_name, created_at, original_tokens, compressed_tokens, target_tokens, instructions) -> None`
    - `add_source(compression_id, commit_hash, position) -> None`
    - `add_result(compression_id, commit_hash, position) -> None`
    - `get_record(compression_id) -> CompressionRow | None`
    - `get_sources(compression_id) -> list[CompressionSourceRow]` (ordered by position)
    - `get_results(compression_id) -> list[CompressionResultRow]` (ordered by position)
    - `is_source_of(commit_hash) -> bool` (True if this commit is a source in any compression)
    - `get_all_source_hashes(tract_id) -> set[str]` (all source commit hashes for a tract)

    **sqlite.py** -- Add `SqliteCompressionRepository(CompressionRepository)`:
    - Implement all ABC methods using SQLAlchemy session queries
    - `save_record()` creates a CompressionRow and adds to session (flush, not commit)
    - `add_source()` / `add_result()` create association rows
    - `is_source_of()` uses `session.execute(select(CompressionSourceRow).where(commit_hash == ...)).first() is not None`
    - `get_all_source_hashes()` uses `select(CompressionSourceRow.commit_hash).join(CompressionRow).where(tract_id == ...)`
    - Import CompressionRow, CompressionSourceRow, CompressionResultRow from schema

    **engine.py** -- Add v2->v3 migration in `init_db()`:
    - After the `elif existing.value == "1"` block, add:
      ```python
      elif existing.value == "2":
          # Migrate v2 -> v3: create compression record tables
          for table_name in ["compressions", "compression_sources", "compression_results"]:
              Base.metadata.tables[table_name].create(engine, checkfirst=True)
          existing.value = "3"
          session.commit()
      ```
    - Update the new database version from "2" to "3" in the `if existing is None` block

    Do NOT import CompressionRepository or SqliteCompressionRepository from `__init__.py` files yet -- that happens when Tract.open() is updated in plan 04-02.
  </action>
  <verify>
    Run `python -m pytest tests/ -x -q` -- all 489 existing tests pass (no regressions from schema changes).
    Run `python -c "from tract.storage.schema import CompressionRow, CompressionSourceRow, CompressionResultRow; print('OK')"` -- imports work.
    Run `python -c "from tract.storage.sqlite import SqliteCompressionRepository; print('OK')"` -- imports work.
  </verify>
  <done>
    3 new ORM tables defined in schema.py. CompressionRepository ABC in repositories.py with 8 methods. SqliteCompressionRepository in sqlite.py implementing all 8 methods. init_db() migrates v2->v3. All 489 existing tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Domain models, exception, summarization prompt, and storage tests</name>
  <files>
    src/tract/models/compression.py
    src/tract/prompts/__init__.py
    src/tract/prompts/summarize.py
    src/tract/exceptions.py
    tests/test_compression_storage.py
  </files>
  <action>
    **models/compression.py** -- Create new file with frozen dataclasses:

    1. `CompressResult(frozen=True)`:
       - `compression_id: str`
       - `original_tokens: int`
       - `compressed_tokens: int`
       - `source_commits: list[str]` (commit hashes of compressed originals)
       - `summary_commits: list[str]` (commit hashes of new summaries)
       - `preserved_commits: list[str]` (commit hashes of PINNED commits that survived)
       - `compression_ratio: float` (compressed_tokens / original_tokens)
       - `new_head: str` (the new HEAD after compression)

    2. `PendingCompression` (NOT frozen -- needs mutable summaries):
       - `summaries: list[str]` (draft summary texts, editable)
       - `source_commits: list[str]`
       - `preserved_commits: list[str]`
       - `original_tokens: int`
       - `estimated_tokens: int`
       - `_commit_fn: object | None = None` (private, set by Tract, callable to finalize)
       - Method `edit_summary(index: int, new_text: str) -> None`: replaces summaries[index]
       - Method `approve() -> CompressResult`: calls self._commit_fn(self) and returns result. Raises CompressionError if _commit_fn is None.

    3. `GCResult(frozen=True)`:
       - `commits_removed: int`
       - `blobs_removed: int`
       - `tokens_freed: int`
       - `archives_removed: int` (compression source commits removed)
       - `duration_seconds: float`

    4. `ReorderWarning(frozen=True)`:
       - `warning_type: str` ("edit_before_target", "response_chain_break", "semantic_change")
       - `commit_hash: str`
       - `description: str`
       - `severity: str` ("structural" or "semantic")

    **prompts/__init__.py** -- Create empty `__init__.py` for the prompts package.

    **prompts/summarize.py** -- Create new file with:

    1. `DEFAULT_SUMMARIZE_SYSTEM: str` -- System prompt for summarization:
       - "You are a context summarizer for an AI assistant's conversation history."
       - Guidelines: third-person narrative prose, preserve specific details (names, numbers, code, decisions), prioritize info affecting future conversation quality, omit pleasantries, aim for target token count if specified, begin with "Previously in this conversation:"
       - See RESEARCH.md Example 5 for the exact wording.

    2. `build_summarize_prompt(messages_text: str, *, target_tokens: int | None = None, instructions: str | None = None) -> str`:
       - Builds the user prompt: "Summarize the following conversation segment:\n\n{messages_text}"
       - Appends "\nTarget approximately {target_tokens} tokens." if target_tokens given
       - Appends "\nAdditional instructions: {instructions}" if instructions given

    **exceptions.py** -- Add `CompressionError(TraceError)` after CherryPickError:
    ```python
    class CompressionError(TraceError):
        """Raised when compression fails."""
    ```

    Also add `GCError(TraceError)`:
    ```python
    class GCError(TraceError):
        """Raised when garbage collection fails."""
    ```

    **tests/test_compression_storage.py** -- Create test file covering:

    1. Schema tests (~5 tests):
       - `test_compression_tables_created`: init_db creates all 3 compression tables
       - `test_migration_v2_to_v3`: start with schema_version=2, call init_db, verify tables + version=3
       - `test_new_db_starts_at_v3`: fresh database gets schema_version=3
       - `test_compression_row_roundtrip`: create CompressionRow, save, retrieve
       - `test_compression_source_result_roundtrip`: create source + result rows, retrieve

    2. Repository tests (~8 tests):
       - `test_save_and_get_record`: save_record() then get_record() returns matching data
       - `test_add_and_get_sources`: add_source() x3, get_sources() returns in position order
       - `test_add_and_get_results`: add_result() x2, get_results() returns in position order
       - `test_is_source_of_true`: commit that is a compression source returns True
       - `test_is_source_of_false`: commit that is not a compression source returns False
       - `test_get_all_source_hashes`: returns set of all source hashes for a tract
       - `test_get_record_not_found`: get_record() returns None for nonexistent compression_id
       - `test_get_sources_empty`: get_sources() returns empty list for nonexistent compression_id

    3. Model tests (~5 tests):
       - `test_compress_result_frozen`: CompressResult is immutable
       - `test_pending_compression_edit_summary`: edit_summary() replaces text at index
       - `test_pending_compression_approve_no_fn`: approve() without _commit_fn raises CompressionError
       - `test_gc_result_frozen`: GCResult is immutable
       - `test_reorder_warning_frozen`: ReorderWarning is immutable

    4. Prompt tests (~3 tests):
       - `test_default_system_prompt_not_empty`: DEFAULT_SUMMARIZE_SYSTEM is a non-empty string
       - `test_build_prompt_basic`: build_summarize_prompt("text") includes the text
       - `test_build_prompt_with_target_and_instructions`: includes target tokens and instructions

    Use the same test fixtures and patterns as existing test files (conftest.py with in-memory DB, session fixtures, etc.). For schema/repo tests, create real commits first since CompressionSourceRow and CompressionResultRow have ForeignKey constraints to commits.commit_hash.
  </action>
  <verify>
    Run `python -m pytest tests/test_compression_storage.py -v` -- all ~21 new tests pass.
    Run `python -m pytest tests/ -x -q` -- all existing tests plus new tests pass (total ~510).
    Run `python -c "from tract.models.compression import CompressResult, PendingCompression, GCResult, ReorderWarning; print('OK')"` -- all models importable.
    Run `python -c "from tract.prompts.summarize import DEFAULT_SUMMARIZE_SYSTEM, build_summarize_prompt; print('OK')"` -- prompt importable.
    Run `python -c "from tract.exceptions import CompressionError, GCError; print('OK')"` -- exceptions importable.
  </verify>
  <done>
    4 domain models in models/compression.py. Default summarization prompt in prompts/summarize.py. CompressionError and GCError in exceptions.py. ~21 new tests covering schema, repository, models, and prompt. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/ -x -q` -- all tests pass (489 existing + ~21 new)
2. `python -c "from tract.storage.schema import CompressionRow, CompressionSourceRow, CompressionResultRow"` -- schema importable
3. `python -c "from tract.storage.sqlite import SqliteCompressionRepository"` -- repo importable
4. `python -c "from tract.models.compression import CompressResult, PendingCompression, GCResult, ReorderWarning"` -- models importable
5. `python -c "from tract.prompts.summarize import DEFAULT_SUMMARIZE_SYSTEM, build_summarize_prompt"` -- prompt importable
6. `python -c "from tract.exceptions import CompressionError, GCError"` -- exceptions importable
7. Schema migration: manually verify init_db() creates compression tables on fresh DB and migrates v2->v3
</verification>

<success_criteria>
1. 3 new ORM tables (compressions, compression_sources, compression_results) created by init_db()
2. Schema migration v2->v3 works for existing databases (Phase 3 databases at v2)
3. CompressionRepository ABC has 8 methods; SqliteCompressionRepository implements all
4. CompressResult, PendingCompression, GCResult, ReorderWarning are importable frozen/mutable dataclasses
5. Default summarization prompt is a Python module with system prompt constant + builder function
6. CompressionError and GCError exceptions exist
7. ~21 new tests pass; 489 existing tests have zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/04-compression/04-01-SUMMARY.md`
</output>
