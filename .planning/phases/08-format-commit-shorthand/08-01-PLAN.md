---
phase: 08-format-commit-shorthand
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/tract/protocols.py
  - src/tract/tract.py
  - tests/test_format_shorthand.py
autonomous: true

must_haves:
  truths:
    - "User can call compiled.to_dicts() and receive a list[dict] with role/content keys"
    - "User can call compiled.to_openai() and receive OpenAI-format messages (system inline)"
    - "User can call compiled.to_anthropic() and receive dict with separate 'system' key and 'messages' list"
    - "User can call t.system('prompt') without importing InstructionContent"
    - "User can call t.user('hello') without importing DialogueContent"
    - "User can call t.assistant('response') without importing DialogueContent"
    - "User can omit message= on commit() and get an auto-generated commit message"
    - "message='' stores empty string (explicit), message=None triggers auto-generation"
  artifacts:
    - path: "src/tract/protocols.py"
      provides: "to_dicts(), to_openai(), to_anthropic() methods on CompiledContext"
      contains: "def to_dicts"
    - path: "src/tract/tract.py"
      provides: "system(), user(), assistant() shorthand methods; auto-message in commit()"
      contains: "def system"
    - path: "tests/test_format_shorthand.py"
      provides: "Tests for all format methods, shorthand methods, and auto-message"
      min_lines: 100
  key_links:
    - from: "src/tract/tract.py (system/user/assistant)"
      to: "src/tract/tract.py (commit)"
      via: "self.commit() delegation"
      pattern: "self\\.commit\\("
    - from: "src/tract/tract.py (commit)"
      to: "src/tract/engine/commit.py (extract_text_from_content)"
      via: "auto-message text extraction"
      pattern: "extract_text_from_content"
    - from: "src/tract/protocols.py (to_anthropic)"
      to: "Anthropic API format"
      via: "system message extraction to separate key"
      pattern: "system.*messages"
---

<objective>
Add format methods on CompiledContext and commit shorthand on Tract to eliminate boilerplate for the two most common operations: consuming compiled output and committing messages.

Purpose: This is the foundation of the v3 DX overhaul. The path from compile() to LLM-ready dicts should require zero manual transformation, and committing a message should not require importing content model classes.

Output: Three method groups -- (1) CompiledContext.to_dicts/to_openai/to_anthropic, (2) Tract.system/user/assistant, (3) auto-generated commit messages -- plus comprehensive tests.
</objective>

<execution_context>
@C:\Users\jinwi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jinwi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-format-commit-shorthand/08-RESEARCH.md
@src/tract/protocols.py
@src/tract/tract.py
@src/tract/models/content.py
@src/tract/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add format methods on CompiledContext</name>
  <files>src/tract/protocols.py, tests/test_format_shorthand.py</files>
  <action>
Add three methods to the `CompiledContext` frozen dataclass in `src/tract/protocols.py`:

1. **`to_dicts(self) -> list[dict[str, str]]`**: Convert messages to list of dicts with "role" and "content" keys. Include "name" key when `m.name is not None`.

2. **`to_openai(self) -> list[dict[str, str]]`**: Identical to `to_dicts()` -- OpenAI uses inline system messages. Just delegate to `self.to_dicts()`.

3. **`to_anthropic(self) -> dict[str, object]`**: Return a dict with two keys:
   - `"system"`: Concatenated system message text (joined with `"\n\n"`), or `None` if no system messages
   - `"messages"`: list[dict] containing all non-system messages with role/content (and name when present)

   This is structurally different from OpenAI because Anthropic does NOT support `role: "system"` in the messages array. Non-standard roles like "tool" should be passed through as-is in the messages list.

Create `tests/test_format_shorthand.py` with tests for:
- `to_dicts()` with basic messages (system, user, assistant)
- `to_dicts()` with name field present and absent
- `to_dicts()` with empty messages list
- `to_openai()` returns same as `to_dicts()`
- `to_anthropic()` extracts system messages to separate key
- `to_anthropic()` with multiple system messages (concatenated with \n\n)
- `to_anthropic()` with no system messages (system key is None)
- `to_anthropic()` preserves name field on non-system messages
- `to_anthropic()` passes "tool" role through in messages list
- Integration: `Tract.open() -> commit -> compile -> to_dicts()` end-to-end
  </action>
  <verify>Run `python -m pytest tests/test_format_shorthand.py -v` -- all tests pass. Run `python -m pytest tests/ -x --timeout=120` -- no regressions in existing tests.</verify>
  <done>CompiledContext has to_dicts(), to_openai(), to_anthropic() methods. to_dicts() returns list[dict] with role/content/name. to_openai() delegates to to_dicts(). to_anthropic() returns {"system": str|None, "messages": list[dict]}. All format tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Add shorthand commit methods on Tract</name>
  <files>src/tract/tract.py, tests/test_format_shorthand.py</files>
  <action>
Add three shorthand methods to the `Tract` class in `src/tract/tract.py`, placed after the `commit()` method and before `compile()` (in the "Public methods" section):

1. **`system(self, text: str, *, message: str | None = None, metadata: dict | None = None) -> CommitInfo`**:
   - Import `InstructionContent` from `tract.models.content` (inside method body to match codebase lazy-import style)
   - Call `self.commit(InstructionContent(text=text), message=message, metadata=metadata)`
   - Docstring: "Commit a system instruction.\n\nShorthand for ``commit(InstructionContent(text=text))``."

2. **`user(self, text: str, *, message: str | None = None, name: str | None = None, metadata: dict | None = None) -> CommitInfo`**:
   - Import `DialogueContent` from `tract.models.content`
   - Call `self.commit(DialogueContent(role="user", text=text, name=name), message=message, metadata=metadata)`
   - Docstring: "Commit a user message.\n\nShorthand for ``commit(DialogueContent(role='user', text=text))``."

3. **`assistant(self, text: str, *, message: str | None = None, name: str | None = None, metadata: dict | None = None, generation_config: dict | None = None) -> CommitInfo`**:
   - Import `DialogueContent` from `tract.models.content`
   - Call `self.commit(DialogueContent(role="assistant", text=text, name=name), message=message, metadata=metadata, generation_config=generation_config)`
   - Only `assistant()` accepts `generation_config` (system prompts and user messages don't have generation configs).
   - Docstring: "Commit an assistant response.\n\nShorthand for ``commit(DialogueContent(role='assistant', text=text))``."

All three methods must go through `self.commit()` so that cache updates, policy evaluation, orchestrator triggers, and budget enforcement all fire correctly.

Add tests to `tests/test_format_shorthand.py`:
- `t.system("prompt")` creates commit with InstructionContent, role="system" in compiled output
- `t.user("hello")` creates commit with DialogueContent(role="user"), role="user" in compiled output
- `t.assistant("response")` creates commit with DialogueContent(role="assistant"), role="assistant" in compiled output
- `t.user("hello", name="Alice")` preserves name field through compile
- `t.assistant("resp", generation_config={"model": "gpt-4"})` stores generation_config
- Shorthand methods return CommitInfo
- Integration: `t.system("prompt") -> t.user("hi") -> t.assistant("hello") -> t.compile().to_dicts()` produces correct 3-message list without any content model imports
  </action>
  <verify>Run `python -m pytest tests/test_format_shorthand.py -v` -- all tests pass including new shorthand tests. Run `python -m pytest tests/ -x --timeout=120` -- no regressions.</verify>
  <done>Tract has system(), user(), assistant() methods. Each delegates to commit() with the correct content model. Only assistant() accepts generation_config. No content model imports needed by the user. All shorthand tests pass.</done>
</task>

<task type="auto">
  <name>Task 3: Add auto-generated commit messages</name>
  <files>src/tract/tract.py, tests/test_format_shorthand.py</files>
  <action>
Add auto-message generation to `Tract.commit()` in `src/tract/tract.py`:

1. **Add a module-level helper function** `_auto_message(content_type: str, text: str) -> str` near the top of tract.py (after imports, before the class):
   - `_MAX_AUTO_MSG_LEN = 72`
   - Strip and flatten newlines from text: `preview = text.strip().replace("\n", " ")`
   - If preview is longer than `_MAX_AUTO_MSG_LEN - len(content_type) - 2`, truncate: `max_text = _MAX_AUTO_MSG_LEN - len(content_type) - 5` and append "..."
   - Return `f"{content_type}: {preview}"` if preview is non-empty, otherwise just `content_type`

2. **Modify `Tract.commit()`** -- after the dict content validation block (line ~420 where `isinstance(content, dict)` is handled) but BEFORE calling `self._commit_engine.create_commit()`:
   ```python
   # Auto-generate commit message if not provided
   if message is None:
       from tract.engine.commit import extract_text_from_content as _extract_text
       if isinstance(content, BaseModel):
           _text = _extract_text(content)
           _ctype = content.model_dump(mode="json").get("content_type", "unknown")
           message = _auto_message(_ctype, _text)
   ```
   Note: By this point, dict content has already been validated into a BaseModel, so the `isinstance(content, BaseModel)` check will be True for both original BaseModel content and validated dict content.

3. **Important boundary:** `message=None` triggers auto-generation. `message=""` (empty string) stores an empty string. This is the natural Python convention -- no sentinel values needed.

4. **Do NOT modify CommitEngine.create_commit()** -- auto-message logic lives only in the Tract facade. Internal callers (merge, compression, etc.) that pass `message=None` should continue to store None.

Add tests to `tests/test_format_shorthand.py`:
- `t.commit(InstructionContent(text="Be helpful"))` without message= generates "instruction: Be helpful"
- `t.commit(DialogueContent(role="user", text="Hello world"))` generates "dialogue: Hello world"
- `t.system("Be helpful")` generates auto-message (shorthand inherits auto-message)
- Long text gets truncated with "..." to stay within 72 chars
- `message=""` stores empty string (NOT auto-generated)
- `message="custom"` stores "custom" (NOT auto-generated)
- Dict content also gets auto-message after validation
- Multi-line text is flattened to single line
- FreeformContent with dict payload generates reasonable message
  </action>
  <verify>Run `python -m pytest tests/test_format_shorthand.py -v` -- all tests pass including auto-message tests. Run `python -m pytest tests/ -x --timeout=120` -- no regressions (critical: existing tests that rely on message=None behavior in CommitEngine must still pass since we only changed the Tract facade).</verify>
  <done>commit() auto-generates descriptive messages when message=None. message="" stores empty string. Shorthand methods inherit auto-message behavior. Truncation works at 72 chars. No regressions in existing tests (CommitEngine unchanged).</done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_format_shorthand.py -v` -- all new tests pass
2. `python -m pytest tests/ -x --timeout=120` -- full suite passes, no regressions
3. Quick smoke test in Python REPL:
   ```python
   from tract import Tract
   t = Tract.open()
   t.system("You are a helpful assistant")
   t.user("Hello!")
   t.assistant("Hi there!")
   compiled = t.compile()
   print(compiled.to_dicts())    # list[dict] with 3 messages
   print(compiled.to_openai())   # same as to_dicts()
   print(compiled.to_anthropic())  # {"system": "You are a helpful assistant", "messages": [user, assistant]}
   t.close()
   ```
4. Verify auto-messages: check that commits created without explicit message= have descriptive auto-generated messages via `t.log()`
</verification>

<success_criteria>
1. compiled.to_dicts() returns list[dict] with "role" and "content" keys (FMT-01)
2. compiled.to_openai() returns same format as to_dicts() (FMT-02)
3. compiled.to_anthropic() returns {"system": str|None, "messages": list[dict]} (FMT-02)
4. t.system(), t.user(), t.assistant() work without importing content models (CORE-01)
5. commit() auto-generates messages when message=None (CORE-03)
6. Zero-transformation path: compile() -> to_dicts() requires no manual work (CORE-02)
7. All existing tests pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/08-format-commit-shorthand/08-01-SUMMARY.md`
</output>
