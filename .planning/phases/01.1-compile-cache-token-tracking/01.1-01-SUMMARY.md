# Phase 1.1 Plan 01: Incremental Compile Cache Summary

**One-liner:** CompileSnapshot-based incremental cache makes APPEND-only compile O(1) with correct invalidation for EDIT/annotate/batch/time-travel/custom-compiler paths.

## Metadata

- **Phase:** 01.1-compile-cache-token-tracking
- **Plan:** 01
- **Subsystem:** engine/compiler, repo
- **Tags:** cache, incremental, compile, performance, snapshot
- **Duration:** ~3m
- **Completed:** 2026-02-11

## What Was Built

### CompileSnapshot Dataclass (protocols.py)
Frozen dataclass that stores intermediate compilation state: raw messages (pre-aggregation), aggregated messages (post-aggregation), effective commit hashes, commit count, token count, and token source. This enables incremental extension without full chain walks.

### build_message_for_commit() Helper (engine/compiler.py)
Extracted from the `_build_messages()` loop body into a public method on `DefaultContextCompiler`. Takes a single `CommitRow` and returns a `Message` -- the single-commit building block for incremental extension. `_build_messages()` now delegates to this method.

### Incremental Cache in Repo (repo.py)
Replaced the simple `dict[str, CompiledContext]` cache with a `CompileSnapshot | None` field. Key behaviors:

- **APPEND commits**: If snapshot exists and compiler is DefaultContextCompiler, extend incrementally (build one message, tail-aggregate, recount tokens)
- **EDIT commits**: Invalidate snapshot (set to None)
- **annotate()**: Invalidate snapshot
- **batch()**: Invalidate on entry; first compile after batch rebuilds from scratch
- **Time-travel params** (as_of, up_to): Bypass cache entirely, don't overwrite snapshot
- **Custom compilers**: Bypass incremental cache (always full compile)

## Commits

| Hash | Type | Description |
|------|------|-------------|
| `085ad33` | feat | Add CompileSnapshot dataclass and extract build_message_for_commit |
| `ce68014` | test | Add 7 failing tests for incremental compile cache (RED) |
| `ee39aa4` | feat | Implement incremental compile cache with CompileSnapshot (GREEN) |

## Key Files

### Created
- None (all modifications to existing files)

### Modified
- `src/tract/protocols.py` -- Added CompileSnapshot frozen dataclass
- `src/tract/engine/compiler.py` -- Extracted build_message_for_commit() public method
- `src/tract/repo.py` -- Replaced _compile_cache with _compile_snapshot, added incremental extend logic
- `src/tract/__init__.py` -- Added CompileSnapshot to exports
- `tests/test_repo.py` -- Added TestIncrementalCompileCache with 7 tests

## Test Results

- **Total tests:** 207 (200 existing + 7 new)
- **All passing:** Yes
- **New test class:** TestIncrementalCompileCache

| Test | What It Proves |
|------|---------------|
| test_append_fast_path_matches_full_compile | Incremental == full compile for APPEND chains |
| test_append_same_role_aggregation | Tail aggregation works correctly for same-role messages |
| test_edit_invalidates_cache | EDIT commits set snapshot to None |
| test_annotate_invalidates_cache | annotate() sets snapshot to None |
| test_batch_invalidates_and_rebuilds | batch() invalidates on entry, rebuild works after |
| test_time_travel_bypasses_cache | Time-travel doesn't overwrite cached snapshot |
| test_custom_compiler_bypasses_incremental | Custom compilers get fresh compile() calls |

## Decisions Made

| Decision | Rationale |
|----------|-----------|
| CompileSnapshot stores both raw_messages and aggregated_messages | Enables correct tail aggregation when extending (need to know if last message is already aggregated) |
| build_message_for_commit returns placeholder for missing blobs | Graceful degradation rather than crash; matches existing _build_messages behavior |
| _build_snapshot_from_compiled uses aggregated messages for both raw and aggregated | When building from a full compile result, the messages are already aggregated; raw pre-aggregation info is only meaningful during incremental extension |
| Batch invalidates on entry, not on exit | Simpler semantics; during batch, individual commits set snapshot to None anyway since session.commit is no-op'd |

## Deviations from Plan

None -- plan executed exactly as written.

## Success Criteria Verification

1. CompileSnapshot dataclass in protocols.py, importable from tract -- VERIFIED
2. build_message_for_commit() is a public method on DefaultContextCompiler -- VERIFIED
3. APPEND commits extend the snapshot incrementally (O(1)) -- VERIFIED (test_append_fast_path_matches_full_compile)
4. EDIT commits invalidate the snapshot -- VERIFIED (test_edit_invalidates_cache)
5. annotate() invalidates the snapshot -- VERIFIED (test_annotate_invalidates_cache)
6. batch() invalidates on entry, rebuilds after -- VERIFIED (test_batch_invalidates_and_rebuilds)
7. Time-travel params bypass cache without overwriting snapshot -- VERIFIED (test_time_travel_bypasses_cache)
8. Custom compilers bypass incremental cache entirely -- VERIFIED (test_custom_compiler_bypasses_incremental)
9. All 207 tests pass with no regressions -- VERIFIED
