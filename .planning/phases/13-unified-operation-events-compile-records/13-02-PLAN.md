---
phase: 13-unified-operation-events-compile-records
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - src/tract/operations/compression.py
  - src/tract/operations/rebase.py
  - src/tract/tract.py
  - src/tract/session.py
  - src/tract/operations/spawn.py
  - src/tract/models/merge.py
  - src/tract/models/compression.py
  - src/tract/exceptions.py
  - src/tract/__init__.py
  - tests/test_compression.py
  - tests/test_gc.py
  - tests/test_rebase.py
autonomous: true

must_haves:
  truths:
    - "compress_range() and _commit_compression() use event_repo instead of compression_repo to record events"
    - "gc() queries OperationCommitRow (via event_repo.is_source_of) to protect source commits"
    - "rebase() creates an OperationEvent of type 'reorganize' with source/result commit mappings"
    - "cherry_pick() is dissolved: Tract.import_commit() exists and creates normal commit + 'import' event"
    - "Tract.__init__/open/from_components accept event_repo instead of compression_repo"
    - "Session.create_tract and spawn_tract use SqliteOperationEventRepository"
    - "CherryPickResult, CherryPickIssue, CherryPickError removed from public exports (clean break)"
    - "All existing compression and gc tests pass with event_repo wiring"
    - "All rebase tests pass with reorganize event creation"
  artifacts:
    - path: "src/tract/operations/compression.py"
      provides: "compress_range and gc using event_repo"
      contains: "event_repo"
    - path: "src/tract/operations/rebase.py"
      provides: "rebase with reorganize events, import_commit replacing cherry_pick"
      contains: "import_commit"
    - path: "src/tract/tract.py"
      provides: "Tract wired with event_repo, import_commit method"
      contains: "_event_repo"
    - path: "tests/test_compression.py"
      provides: "Updated compression tests with event_repo"
    - path: "tests/test_gc.py"
      provides: "Updated GC tests with event_repo"
    - path: "tests/test_rebase.py"
      provides: "Updated rebase tests with reorganize events + import_commit"
  key_links:
    - from: "src/tract/tract.py"
      to: "src/tract/operations/compression.py"
      via: "event_repo parameter threading"
    - from: "src/tract/tract.py"
      to: "src/tract/operations/rebase.py"
      via: "event_repo parameter for reorganize events"
    - from: "src/tract/operations/compression.py"
      to: "src/tract/storage/repositories.py"
      via: "OperationEventRepository type annotation"
---

<objective>
Wire the new OperationEventRepository through all operation code: compression, GC, rebase, cherry-pick dissolution, and the Tract facade. Replace all references to compression_repo with event_repo. Create reorganize events in rebase. Dissolve cherry-pick into import_commit. Remove cherry-pick public API artifacts. Update all affected tests.

Purpose: This is the bulk operation rewrite -- all structural operations now record unified events.
Output: Fully wired compression, GC, rebase, and import operations using unified events. All tests updated and passing.
</objective>

<execution_context>
@C:\Users\jinwi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jinwi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-unified-operation-events-compile-records/13-RESEARCH.md
@.planning/phases/13-unified-operation-events-compile-records/13-01-SUMMARY.md
@src/tract/operations/compression.py
@src/tract/operations/rebase.py
@src/tract/tract.py
@src/tract/session.py
@src/tract/operations/spawn.py
@src/tract/__init__.py
@src/tract/exceptions.py
@src/tract/models/merge.py
@src/tract/models/compression.py
@tests/test_compression.py
@tests/test_gc.py
@tests/test_rebase.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewire compression, GC, rebase, and cherry-pick dissolution</name>
  <files>
    src/tract/operations/compression.py
    src/tract/operations/rebase.py
    src/tract/models/merge.py
    src/tract/models/compression.py
    src/tract/exceptions.py
  </files>
  <action>
**In `src/tract/operations/compression.py`:**

1. Replace ALL references to `CompressionRepository` with `OperationEventRepository` in TYPE_CHECKING imports. Remove `CompressionRepository` import.

2. In `compress_range()` function signature: rename parameter `compression_repo` to `event_repo` (type: `OperationEventRepository`).

3. In `_commit_compression()` function signature: rename parameter `compression_repo` to `event_repo`.

4. In `_commit_compression()` body: replace all `compression_repo.save_record(...)` calls with `event_repo.save_event(...)`. The mapping is:
   - `compression_id` -> `event_id` (same UUID)
   - `event_type="compress"`
   - `target_tokens` and `instructions` go into `params_json={"target_tokens": ..., "instructions": ...}` instead of being separate columns
   - Replace `compression_repo.add_source(compression_id, hash, pos)` with `event_repo.add_commit(event_id, hash, "source", pos)`
   - Replace `compression_repo.add_result(compression_id, hash, pos)` with `event_repo.add_commit(event_id, hash, "result", pos)`

5. In `gc()` function signature: rename parameter `compression_repo` to `event_repo` (type: `OperationEventRepository`).

6. In `gc()` body:
   - Replace `compression_repo.is_source_of(commit_hash)` with `event_repo.is_source_of(commit_hash)` (SC-7)
   - Replace `compression_repo.get_all_source_hashes(tract_id)` with `event_repo.get_all_source_hashes(tract_id)` (same signature)
   - Replace `compression_repo.delete_source(hash)` with `event_repo.delete_commit(hash)` (deletes all roles for that hash)
   - Replace `compression_repo.delete_result(hash)` with `event_repo.delete_commit(hash)`
   - Replace `compression_repo.get_all_ids(tract_id)` with `event_repo.get_all_ids(tract_id)`
   - Replace `compression_repo.delete_record(id)` with `event_repo.delete_event(id)`
   - Replace `compression_repo.get_sources(id)` with `event_repo.get_commits(id, "source")`
   - Replace `compression_repo.get_results(id)` with `event_repo.get_commits(id, "result")`

7. The `CompressResult` dataclass still uses `compression_id` field -- keep it as is, it's just a string ID. The internal mapping is `compression_id = event_id`.

**In `src/tract/operations/rebase.py`:**

8. Add `OperationEventRepository` to TYPE_CHECKING imports (from `tract.storage.repositories`).

9. In `rebase()` function signature: add parameter `event_repo: OperationEventRepository | None = None`.

10. After the replay loop completes successfully (where RebaseResult is being constructed), add event recording:
    ```python
    if event_repo is not None:
        import uuid as _uuid
        from datetime import datetime, timezone
        event_id = _uuid.uuid4().hex
        event_repo.save_event(
            event_id=event_id,
            tract_id=tract_id,
            event_type="reorganize",
            branch_name=current_branch,  # the branch being rebased
            created_at=datetime.now(timezone.utc),
            original_tokens=0,
            compressed_tokens=0,
            params_json={"target_branch": target_branch},
        )
        for pos, orig in enumerate(commits_to_replay):
            event_repo.add_commit(event_id, orig.commit_hash, "source", pos)
        for pos, replayed in enumerate(replayed_infos):
            event_repo.add_commit(event_id, replayed.commit_hash, "result", pos)
    ```

11. **Dissolve `cherry_pick()` into `import_commit()`**: Rename the function `cherry_pick` to `import_commit`. Add `event_repo: OperationEventRepository | None = None` parameter. After creating the new commit, record an "import" event:
    ```python
    if event_repo is not None:
        import uuid as _uuid
        from datetime import datetime, timezone
        event_id = _uuid.uuid4().hex
        event_repo.save_event(
            event_id=event_id,
            tract_id=tract_id,
            event_type="import",
            branch_name=None,
            created_at=datetime.now(timezone.utc),
            original_tokens=0,
            compressed_tokens=0,
            params_json={"original_commit": commit_hash},
        )
        event_repo.add_commit(event_id, commit_hash, "source", 0)
        if result.new_commit is not None:
            event_repo.add_commit(event_id, result.new_commit.commit_hash, "result", 0)
    ```
    Keep `CherryPickResult` as the return type for now (it's renamed in a moment). Actually, **rename the return type**: Change `CherryPickResult` -> create `ImportResult` in models. Wait -- to minimize churn, keep using `CherryPickResult` internally but rename the function. The result model rename happens below.

12. Remove `CherryPickError` import. Import `TraceError` instead (or use a generic error). Actually, look at what CherryPickError is used for -- it's raised when issues are detected and no resolver. Replace with `TraceError` or keep CherryPickError for now and remove it from public exports only. **Decision: Keep CherryPickError as an internal class but remove from __init__.py exports.** Actually cleaner: rename to `ImportCommitError` in exceptions.py.

**In `src/tract/exceptions.py`:**

13. Rename `CherryPickError` to `ImportCommitError`. Keep the old name as an alias for any internal references: `CherryPickError = ImportCommitError` -- NO, clean break per SC-8. Just rename it everywhere.

**In `src/tract/models/merge.py`:**

14. Rename `CherryPickResult` to `ImportResult`. Rename `CherryPickIssue` to `ImportIssue`. Update all field references. The field structure stays the same:
    - `ImportIssue`: same fields as CherryPickIssue (issue_type, commit, target_branch_head, missing_target, description)
    - `ImportResult`: same fields as CherryPickResult (original_commit, new_commit, issues: list[ImportIssue], resolutions)

**In `src/tract/models/compression.py`:**

15. The `GCResult` dataclass has `archives_removed: int` field. This semantically maps to "event source commits that were eligible for removal." Keep the field name or rename to `source_commits_removed`. **Decision: rename to `source_commits_removed: int`** for clarity with the unified model.
  </action>
  <verify>
    Run: `python -c "from tract.operations.compression import compress_range, gc; print('OK')"` -- no import errors.
    Run: `python -c "from tract.operations.rebase import rebase, import_commit; print('OK')"` -- no import errors.
    Run: `python -c "from tract.models.merge import ImportResult, ImportIssue, RebaseResult; print('OK')"` -- no import errors.
    Run: `python -c "from tract.exceptions import ImportCommitError; print('OK')"` -- no import errors.
    Verify: `grep -c "compression_repo" src/tract/operations/compression.py src/tract/operations/rebase.py` returns 0 for both.
    Verify: `grep -c "CherryPickError\|CherryPickResult\|CherryPickIssue" src/tract/operations/rebase.py src/tract/models/merge.py src/tract/exceptions.py` returns 0 for all.
  </verify>
  <done>
    compress_range() and gc() use event_repo. rebase() creates reorganize events. cherry_pick() dissolved into import_commit() with import events. CherryPickResult/Issue/Error renamed to ImportResult/Issue/Error. GCResult.archives_removed renamed to source_commits_removed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Tract facade, session, spawn, exports, and update tests</name>
  <files>
    src/tract/tract.py
    src/tract/session.py
    src/tract/operations/spawn.py
    src/tract/__init__.py
    tests/test_compression.py
    tests/test_gc.py
    tests/test_rebase.py
  </files>
  <action>
**In `src/tract/tract.py`:**

1. Replace `SqliteCompressionRepository` import with `SqliteOperationEventRepository` (from `tract.storage.sqlite`).

2. In `__init__()`: rename parameter `compression_repo` to `event_repo` (type `SqliteOperationEventRepository | None`). Store as `self._event_repo`. Remove `self._compression_repo`.

3. In `open()`: replace `compression_repo = SqliteCompressionRepository(session)` with `event_repo = SqliteOperationEventRepository(session)`. Update the `cls(...)` call to pass `event_repo=event_repo`.

4. In `from_components()`: No compression_repo parameter exists currently, so no change needed there. BUT: add `event_repo` parameter (optional, default None) so tests can inject it. Store on the instance.

5. In `compress()` method: replace `self._compression_repo` with `self._event_repo` everywhere. Update the call to `compress_range(compression_repo=...)` to `compress_range(event_repo=...)`. Same for `_finalize_compression`.

6. In `gc()` method: replace `self._compression_repo` with `self._event_repo`. Update call to `_gc(compression_repo=...)` to `_gc(event_repo=...)`.

7. In `rebase()` method: add `event_repo=self._event_repo` to the `_rebase(...)` call.

8. Replace `cherry_pick()` method with `import_commit()`:
   - Rename the method from `cherry_pick` to `import_commit`
   - Import `import_commit as _import_commit` from `tract.operations.rebase` (instead of `cherry_pick`)
   - Import `ImportResult` from `tract.models.merge` (instead of `CherryPickResult`)
   - Return type: `ImportResult`
   - Add `event_repo=self._event_repo` to the operation call
   - Replace `CherryPickError` usage in docstring with `ImportCommitError`

9. Update TYPE_CHECKING imports: replace `CherryPickResult` with `ImportResult`.

10. Check for any other references to `_compression_repo` in tract.py and update them all.

**In `src/tract/session.py`:**

11. Replace `SqliteCompressionRepository` import with `SqliteOperationEventRepository`.
12. In `create_tract()`: replace `compression_repo = SqliteCompressionRepository(session)` with `event_repo = SqliteOperationEventRepository(session)`.
13. Update the `Tract(...)` constructor call to pass `event_repo=event_repo`.

**In `src/tract/operations/spawn.py`:**

14. Replace `SqliteCompressionRepository` import with `SqliteOperationEventRepository`.
15. Replace `child_compression_repo = SqliteCompressionRepository(child_session)` with `child_event_repo = SqliteOperationEventRepository(child_session)`.
16. Update the `Tract(...)` / factory call to pass `event_repo=child_event_repo`.

**In `src/tract/__init__.py`:**

17. Remove these exports:
    - `CherryPickIssue` from imports and `__all__`
    - `CherryPickResult` from imports and `__all__`
    - `CherryPickError` from imports and `__all__`

18. Add these exports:
    - `ImportResult` from `tract.models.merge`
    - `ImportIssue` from `tract.models.merge`
    - `ImportCommitError` from `tract.exceptions`

19. Update the `from tract.models.merge import (...)` block: remove CherryPickIssue/CherryPickResult, add ImportResult/ImportIssue.
20. Update the `from tract.exceptions import (...)` block: remove CherryPickError, add ImportCommitError.

**In `tests/test_compression.py`:**

21. Replace ALL references to `compression_repo` with `event_repo`.
22. Replace `SqliteCompressionRepository` with `SqliteOperationEventRepository` in imports and fixtures.
23. Replace `CompressionRepository` with `OperationEventRepository` in any type hints.
24. Update calls to `compress_range(compression_repo=...)` to `compress_range(event_repo=...)`.
25. Update assertions that check compression records:
    - `compression_repo.get_record(...)` -> `event_repo.get_event(...)`
    - `compression_repo.get_sources(...)` -> `event_repo.get_commits(..., "source")`
    - `compression_repo.get_results(...)` -> `event_repo.get_commits(..., "result")`
    - Row field access: `.compression_id` -> `.event_id`, `.commit_hash` stays same, `.position` stays same
26. If tests reference `CompressionRow` directly, replace with `OperationEventRow`.

**In `tests/test_gc.py`:**

27. Same pattern: replace `compression_repo` -> `event_repo`, `SqliteCompressionRepository` -> `SqliteOperationEventRepository`.
28. Update `gc(compression_repo=...)` calls to `gc(event_repo=...)`.
29. Update assertions checking `archives_removed` to `source_commits_removed`.
30. Update any `compression_repo.save_record(...)` test setup calls to `event_repo.save_event(...)`.
31. Update `compression_repo.add_source/add_result(...)` calls to `event_repo.add_commit(..., "source"/"result", ...)`.

**In `tests/test_rebase.py`:**

32. Add imports for `SqliteOperationEventRepository`.
33. Add `event_repo` fixture creating `SqliteOperationEventRepository(session)`.
34. Update rebase test calls to pass `event_repo=event_repo`.
35. Add test assertions verifying reorganize events are created after rebase:
    - `event_repo.get_all_ids(tract_id)` returns at least 1 event
    - Event has `event_type="reorganize"`
    - Source commits match original commit hashes
    - Result commits match replayed commit hashes
36. Replace all `cherry_pick` references with `import_commit`:
    - `from tract.operations.rebase import cherry_pick` -> `from tract.operations.rebase import import_commit`
    - Function calls and test names
37. Replace `CherryPickResult` with `ImportResult`, `CherryPickIssue` with `ImportIssue`, `CherryPickError` with `ImportCommitError`.
38. Add test assertions verifying import events are created after import_commit:
    - Event has `event_type="import"`
    - Source is original commit, result is new commit
  </action>
  <verify>
    Run: `python -m pytest tests/test_compression.py tests/test_gc.py tests/test_rebase.py -v` -- ALL tests pass.
    Run: `python -c "from tract import Tract, ImportResult, ImportCommitError; print('OK')"` -- no import errors.
    Verify: `grep -rn "compression_repo\|SqliteCompressionRepository\|CompressionRepository\|CherryPickResult\|CherryPickIssue\|CherryPickError" src/tract/` returns ZERO matches (excluding comments/docstrings that might mention "cherry-pick" conceptually).
    Verify: `grep -rn "cherry_pick" src/tract/tract.py` returns ZERO matches.
  </verify>
  <done>
    Tract, session, spawn all use event_repo. import_commit() replaces cherry_pick(). Public API updated: ImportResult/ImportIssue/ImportCommitError exported, CherryPickResult/CherryPickIssue/CherryPickError removed. All compression, GC, and rebase tests updated and passing.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_compression.py tests/test_gc.py tests/test_rebase.py -v` -- ALL pass
2. `grep -rn "compression_repo\|SqliteCompressionRepository\|CompressionRepository" src/tract/` -- ZERO matches
3. `grep -rn "CherryPickResult\|CherryPickIssue\|CherryPickError" src/tract/` -- ZERO matches
4. `grep -rn "cherry_pick" src/tract/tract.py src/tract/operations/rebase.py` -- ZERO matches (function name dissolved)
5. `python -c "from tract import ImportResult, ImportIssue, ImportCommitError"` -- no errors
6. `python -c "t = __import__('tract'); assert not hasattr(t, 'CherryPickResult')"` -- passes
</verification>

<success_criteria>
1. compress_range/gc use event_repo (PROV-01)
2. Rebase creates "reorganize" events with source/result mappings (SC-4, PROV-03)
3. cherry_pick dissolved into import_commit with "import" events (SC-5, PROV-04)
4. GC respects OperationCommitRow FKs via event_repo.is_source_of (SC-7, PROV-05)
5. CherryPickResult/Issue/Error removed from public API (SC-8)
6. Zero references to old compression_repo / old types in source
7. All 3 test files pass
</success_criteria>

<output>
After completion, create `.planning/phases/13-unified-operation-events-compile-records/13-02-SUMMARY.md`
</output>
